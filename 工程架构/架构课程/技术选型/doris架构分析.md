分布式 nosql 系统

# 逻辑架构
- 二次架构：Client、DataServer + Store
- 四个核心组件：Client、DataServer、Store、Administration

# 布局结构
- 两台 KV Client(KV: Key|Value)
- 四台 DataServer
- 一台 ConfigServer

# KV Storage 概念模型

# 关键技术点-数据分片

# 如何保持高可用
1. 对等 Node 访问
比如：有 20 台集群，那么可以分为2个 group，一个 group 做10个分片

2. 双写保证可用性
默认策略：**写** 两份，**读** 一份，可以通过 config server 去配置
如果某一台失效，config server 会尝试去写入，如果失败，那么它会去通知所有 client 禁止访问这台失效的 server，这样就可以保证数据的一致性

3. 基于

## 物理服务器状态
1. 失效状态：不可读写
2. 失效恢复状态：可写，不可读
3. 正常状态：可读写

## 失效场景
1. 瞬时失效：kvserver 尝试写入三次，失败后，会通知 configServer 也去尝试写入三次，如果有一次成功，确认是 **瞬时失效**，否则，进入后续判断。
2. 临时失效：（停止读写）
    - 服务器升级或者网络暂时不可用
    - 失效机器在短时间内可恢复（例如：2小时）
    - 恢复后数据和失效前一致
3. 永久失效：机器下线

> 临时失效后，数据转移如何做？

## 临时失效的转移策略
1. 多部署一台 日志节点，用于 **存储临时失效节点的 “写” 操作指令**
2. 临时失效期间，其他节点承担客户端的所有 “读” 操作。
3. 失效节点重新恢复后，进入 **失效恢复状态**，恢复 “写” 操作，并把保存的 “写” 操作在恢复的节点上执行，通过时间戳比对是否有冲突。
4. 恢复正常状态，正常 “读写”

## 永久失效状态的策略

doris 会用一台 standby 的服务器 去替代一台 永久失效的服务器，然后开始迁移数据

# 集群扩容设计
1. 扩容流程
在扩容的时候，把某个 Group 的机器全部进入 **临时失效** 状态，然后添加物理服务器，把物理地址映射到虚拟服务器上（hash一致性算法的逻辑），然后把数据备份到新的物理服务器上，最后再回复到正常状态。

# 注意事项
1. 多服务集群，可以通过给每个服务申请 namespace 来解决关键字冲突的问题